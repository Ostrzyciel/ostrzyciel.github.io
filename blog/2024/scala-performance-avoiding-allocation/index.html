<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Making Scala go fast: avoiding allocations | Piotr Sowi≈Ñski </title> <meta name="author" content="Piotr Sowi≈Ñski"> <meta name="description" content="In this post, we explore the ways in which you can avoid the overhead of allocating things on the heap in Scala 3."> <meta name="keywords" content="academic-website, portfolio-website, blog, ostrzyciel, knowledge-graphs, streaming"> <meta property="og:site_name" content="Piotr Sowi≈Ñski"> <meta property="og:type" content="article"> <meta property="og:title" content="Piotr Sowi≈Ñski | Making Scala go fast: avoiding allocations"> <meta property="og:url" content="https://ostrzyciel.eu/blog/2024/scala-performance-avoiding-allocation/"> <meta property="og:description" content="In this post, we explore the ways in which you can avoid the overhead of allocating things on the heap in Scala 3."> <meta property="og:locale" content="en"> <meta name="twitter:card" content="summary"> <meta name="twitter:title" content="Making Scala go fast: avoiding allocations"> <meta name="twitter:description" content="In this post, we explore the ways in which you can avoid the overhead of allocating things on the heap in Scala 3."> <script type="application/ld+json">
    {
        "author":
        {
            "@type": "Person",
            "name": "Piotr Sowi≈Ñski"
        },
        "url": "https://ostrzyciel.eu/blog/2024/scala-performance-avoiding-allocation/",
        "@type": "BlogPosting",
        "description": "In this post, we explore the ways in which you can avoid the overhead of allocating things on the heap in Scala 3.",
        "headline": "Making Scala go fast: avoiding allocations",
        
        "sameAs": ["https://orcid.org/0000-0002-2543-9461", "https://scholar.google.com/citations?user=MPj9pngAAAAJ", "https://www.researchgate.net/profile/Piotr_Sowinski2", "https://github.com/Ostrzyciel", "https://www.linkedin.com/in/piotr-sowinski"],
        
        "name": "Piotr Sowi≈Ñski",
        "@context": "https://schema.org"
    }
  </script> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Material+Icons|Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?4608794d695ad9fed1682b84f8e83c8e"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://ostrzyciel.eu/blog/2024/scala-performance-avoiding-allocation/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-bold" href="/"> Piotr Sowi≈Ñski </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects &amp; software </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">Teaching </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">Search <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Making Scala go fast: avoiding allocations</h1> <p class="post-meta"> Posted on September 08, 2024 </p> <p class="post-tags mb-0 pb-0"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a> ¬† ¬∑ ¬† <a href="/blog/tag/scala"> <i class="fa-solid fa-hashtag fa-sm"></i> scala</a> ¬† <a href="/blog/tag/jvm"> <i class="fa-solid fa-hashtag fa-sm"></i> jvm</a> ¬† <a href="/blog/tag/performance"> <i class="fa-solid fa-hashtag fa-sm"></i> performance</a> ¬† <a href="/blog/tag/optimization"> <i class="fa-solid fa-hashtag fa-sm"></i> optimization</a> ¬† <a href="/blog/tag/garbage-collection"> <i class="fa-solid fa-hashtag fa-sm"></i> garbage-collection</a> ¬† <a href="/blog/tag/gotta-go-fast"> <i class="fa-solid fa-hashtag fa-sm"></i> gotta-go-fast</a> </p> <p class="mb-4"> <a href="/blog/">&lt;~¬†¬†Go back</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>I love Scala ‚Äì it‚Äôs a very elegant and powerful language. This is why I decided to use it to write a high-performance serializer for knowledge graphs (<a href="https://w3id.org/jelly/jelly-jvm/dev/" rel="external nofollow noopener" target="_blank">Jelly-JVM</a>, go check it out if you are a fan of RDF) and‚Ä¶ oh boy, was it an adventure. I spent <em>way</em> too much time optimizing the code to make the serializer as fast as possible, and in doing that I‚Äôve learned a lot about the quirks of Scala 3 and JVM optimization, which I thought may be worth sharing with others.</p> <p><strong>Welcome to the first post in the ‚Äúgotta go fast‚Äù series about Scala 3 and JVM performance.</strong> If you don‚Äôt want to miss future posts, consider subscribing to my <a href="/feed.xml">RSS/Atom feed</a>.</p> <p>In this post, we explore the ways in which you can avoid the overhead of allocating things on the heap, which for me turned out to be the place where I‚Äôve achieved the most noticeable performance gains.</p> <hr> <p>First things first ‚Äì please remember that <em>premature optimization is the root of all evil</em>. Modern JVMs are pretty smart and can optimize a lot of things for you. <u>Do not</u> optimize your Scala code before you find a clear issue with its performance. <strong>Many techniques described here go against ‚Äúthe Scala way‚Äù, may make your code uglier, or make it easier to introduce bugs into your code.</strong> But, they make it go faster. üòâ You have been warned.</p> <p>With this disclaimer out of the way‚Ä¶</p> <h2 id="the-horror-of-heap-allocations">The horror of heap allocations</h2> <p>At some point you may run in to a situation where your application spends the majority of CPU time allocating objects in the heap and then freeing them with the garbage collector (GC). You can check this easily with any decent profiler. Sure, the allocation mechanism in modern JVMs is pretty efficient<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>, and there is a whole science dedicated to choosing the right GC for a given job, but an allocation is an allocation, and it must come with <em>some</em> performance cost. If you are for example allocating millions of objects per seconds, then it may be worth taking a closer look at.</p> <p>OK, so we have too many allocations ‚Äì the solution then is obvious: <strong>allocate less!</strong> But how?</p> <h2 id="the-scala-bloat-option-either-try">The Scala ‚Äúbloat‚Äù: <code class="language-plaintext highlighter-rouge">Option</code>, <code class="language-plaintext highlighter-rouge">Either</code>, <code class="language-plaintext highlighter-rouge">Try</code> </h2> <p><code class="language-plaintext highlighter-rouge">Option[T]</code> was created as a functional and type-safe alternative to <code class="language-plaintext highlighter-rouge">null</code> in Java, which admittedly is one of the most annoying parts of the language. Same with <code class="language-plaintext highlighter-rouge">Either[T1, T2]</code> for unions and <code class="language-plaintext highlighter-rouge">Try[T]</code> for exceptions. Let‚Äôs look at an example:</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scala.util.</span><span class="o">{</span><span class="nc">Success</span><span class="o">,</span> <span class="nc">Try</span><span class="o">}</span>

<span class="k">val</span> <span class="nv">cat</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"Cat!"</span>
<span class="k">val</span> <span class="nv">someCat</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">cat</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">rightCat</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">Unit</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Right</span><span class="o">(</span><span class="n">cat</span><span class="o">)</span>
<span class="k">val</span> <span class="nv">successCat</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Success</span><span class="o">(</span><span class="n">cat</span><span class="o">)</span>
</code></pre></div></div> <p>Seems pretty normal. But, this ordinary snippet contains four (!) allocations: one <code class="language-plaintext highlighter-rouge">String</code>, one <code class="language-plaintext highlighter-rouge">Some[String]</code>, one <code class="language-plaintext highlighter-rouge">Right[String]</code>, and one <code class="language-plaintext highlighter-rouge">Success[String]</code>. So, every time you simply want to say ‚Äúyes, this variable really does have a value‚Äù and use <code class="language-plaintext highlighter-rouge">Some(value)</code>, you make an allocation. This can add up very, very quickly in a hot path.</p> <p>You can get around this by simply not using these features of Scala. I definitely <em>do not</em> recommend doing this for public APIs, only for internal code. Please also take care to test your code properly, because these great Scala features were designed to protect your code from bugs.</p> <ul> <li>Replace <code class="language-plaintext highlighter-rouge">Option[T]</code> with just <code class="language-plaintext highlighter-rouge">T</code>. Instead of <code class="language-plaintext highlighter-rouge">None</code> use <code class="language-plaintext highlighter-rouge">null</code>. Note that using a <code class="language-plaintext highlighter-rouge">None</code> by itself does not allocate anything new, as <code class="language-plaintext highlighter-rouge">None</code> is a Scala object (singleton), so you only save allocations on removing <code class="language-plaintext highlighter-rouge">Some(...)</code>.</li> <li>Replace <code class="language-plaintext highlighter-rouge">Either[T1, T2]</code> with a <a href="https://docs.scala-lang.org/scala3/book/types-union.html" rel="external nofollow noopener" target="_blank">union type</a>: <code class="language-plaintext highlighter-rouge">T1 | T2</code>. Scala supports these pretty well. The disadvantage is that instead of nice functional methods for accessing the right/left value of an Either, you must use <code class="language-plaintext highlighter-rouge">match</code> expressions instead. Internally, matching by type uses <code class="language-plaintext highlighter-rouge">isInstanceOf</code>, which is really fast on modern JVMs. On the other hand, union types may be seen as <em>nicer</em> in some use cases, as they support the type algebra.</li> <li>Replace <code class="language-plaintext highlighter-rouge">Try[T]</code> with good ol‚Äô exceptions‚Ä¶ or something else entirely, like a union type. You should not rely on exceptions for the ‚Äúnormal‚Äù control flow of your program, but if what you are catching really are <em>exceptions</em>, then it‚Äôs probably fine.</li> </ul> <p>This will make your code look more like Java than Scala ‚Äì it‚Äôs up to you to decide if the speedup is worth it.</p> <h2 id="pre-allocation">Pre-allocation</h2> <p>I‚Äôve already mentioned that using <code class="language-plaintext highlighter-rouge">None</code> by itself is free in terms of allocations ‚Äì it is allocated as a singleton, so every time you use it, you get a reference to the exact same object on the heap. You can use this trick in a few other situations as well.</p> <h3 id="default-instance">Default instance</h3> <p>Let‚Äôs take a simple example:</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Cat</span><span class="o">(</span><span class="n">friends</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Cat</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">())</span>

<span class="k">def</span> <span class="nf">getLonelyCat</span><span class="k">:</span> <span class="kt">Cat</span> <span class="o">=</span> <span class="nc">Cat</span><span class="o">()</span>
</code></pre></div></div> <p>Each time we call the <code class="language-plaintext highlighter-rouge">getLonelyCat</code> method, a new <code class="language-plaintext highlighter-rouge">Cat</code> instance is allocated on the heap. However, as the class is immutable, this does not benefit us in any way. We could have 50 different callers obtain a new lonely cat in this way and none of them would be able to modify their instance of the <code class="language-plaintext highlighter-rouge">Cat</code>. Why not instead give them the exact same instance, saving 49 allocations? They won‚Äôt realize the difference, after all‚Ä¶</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">Cat</span><span class="k">:</span>
  <span class="kt">val</span> <span class="kt">defaultInstance:</span> <span class="kt">Cat</span> <span class="o">=</span> <span class="nc">Cat</span><span class="o">()</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Cat</span><span class="o">(</span><span class="n">friends</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Cat</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">())</span>

<span class="k">def</span> <span class="nf">getLonelyCat</span><span class="k">:</span> <span class="kt">Cat</span> <span class="o">=</span> <span class="nv">Cat</span><span class="o">.</span><span class="py">defaultInstance</span>
</code></pre></div></div> <p>Here we have created a companion object to the <code class="language-plaintext highlighter-rouge">Cat</code> class, which allocates a single new lonely cat at application startup (in Java lingo: <em>static initializer block</em>). We do not allocate any new lonely cats at runtime.</p> <h3 id="commonly-used-instances">Commonly-used instances</h3> <p>You can take the default instance trick further by pre-allocating more than one instance of a class. This admittedly has a narrower range of use cases, but is useful where you have some frequent patterns in the objects you allocate. Let‚Äôs consider a temperature sensor which reports temperature measurements in Kelvin and the status of the sensor:</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">enum</span> <span class="nc">TempSensorStatus</span><span class="k">:</span>
  <span class="kt">case</span> <span class="kt">Normal</span><span class="o">,</span> <span class="nc">TooCold</span><span class="o">,</span> <span class="nc">TooHot</span><span class="o">,</span> <span class="nc">Error</span><span class="o">,</span> <span class="nc">Unresponsive</span>

<span class="c1">// value is in Kelvin</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">TemperatureReading</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span> <span class="n">status</span><span class="k">:</span> <span class="kt">TempSensorStatus</span><span class="o">)</span>

<span class="k">object</span> <span class="nc">TemperatureReading</span><span class="k">:</span>
  <span class="kt">val</span> <span class="kt">tooCold</span> <span class="o">=</span> <span class="nc">TemperatureReading</span><span class="o">(</span><span class="mf">0.0</span><span class="o">,</span> <span class="nv">TempSensorStatus</span><span class="o">.</span><span class="py">TooCold</span><span class="o">)</span>
  <span class="k">val</span> <span class="nv">tooHot</span> <span class="k">=</span> <span class="nc">TemperatureReading</span><span class="o">(</span><span class="mf">1000.0</span><span class="o">,</span> <span class="nv">TempSensorStatus</span><span class="o">.</span><span class="py">TooHot</span><span class="o">)</span>
  <span class="k">val</span> <span class="nv">error</span> <span class="k">=</span> <span class="nc">TemperatureReading</span><span class="o">(</span><span class="nv">Double</span><span class="o">.</span><span class="py">NaN</span><span class="o">,</span> <span class="nv">TempSensorStatus</span><span class="o">.</span><span class="py">Error</span><span class="o">)</span>
  <span class="k">val</span> <span class="nv">unresponsive</span> <span class="k">=</span> <span class="nc">TemperatureReading</span><span class="o">(</span><span class="nv">Double</span><span class="o">.</span><span class="py">NaN</span><span class="o">,</span> <span class="nv">TempSensorStatus</span><span class="o">.</span><span class="py">Unresponsive</span><span class="o">)</span>
</code></pre></div></div> <p>When reading the temperature, you can now just return one of the pre-allocated instances, instead of allocating a new one every time.</p> <p>You could also use an instance cache. When you need to allocate a new object, check if it‚Äôs already in your cache. If yes, then return it to the caller. If not, allocate a new one, store it in the cache, and return to the caller. Note that this is much more complex and it may be hard to get any performance improvement out of this. A lot depends on the efficiency of your cache implementation and generally it only makes sense for large classes with many internal allocations and complex initializer logic.</p> <h2 id="reuse-recycle">Reuse, recycle</h2> <p>In the previous section we exploited immutability to our advantage, but the same characteristic can also cause us headaches elsewhere. A good way to avoid allocating objects would be to just reuse what you have already allocated. But, with immutability, you can‚Äôt just overwrite the old contents with new data!</p> <h3 id="mutable-collections">Mutable collections</h3> <p>Things are immutable in Scala <a href="https://docs.scala-lang.org/scala3/book/fp-immutable-values.html" rel="external nofollow noopener" target="_blank">for a reason</a>, but there are also <a href="https://docs.scala-lang.org/scala3/book/collections-classes.html" rel="external nofollow noopener" target="_blank">mutable collection types</a> which may make sense in some use cases. So, instead of:</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">twoCats</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="s">"Black cat"</span><span class="o">,</span> <span class="s">"Orange cat (smart)"</span><span class="o">)</span>
<span class="c1">// This allocates new instance of List[String]</span>
<span class="k">val</span> <span class="nv">threeCats</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">twoCats</span> <span class="o">:+</span> <span class="s">"White cat (dirty)"</span>
</code></pre></div></div> <p>You could use:</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">cats</span> <span class="k">=</span> <span class="nv">collection</span><span class="o">.</span><span class="py">mutable</span><span class="o">.</span><span class="py">ListBuffer</span><span class="o">(</span><span class="s">"Black cat"</span><span class="o">,</span> <span class="s">"Orange cat (smart)"</span><span class="o">)</span>
<span class="n">cats</span> <span class="o">+=</span> <span class="s">"White cat (dirty)"</span>
</code></pre></div></div> <p>‚Ä¶which optimistically saves us one allocation. Of course, if the underlying collection needs to be expanded, it will internally do some allocations.</p> <h3 id="mutable-fields">Mutable fields</h3> <p>You can also consider using mutable fields in your classes, and reusing previously allocated instances that you don‚Äôt need anymore. This is useful for example in caches, where instead of allocating a new value for the cache, you can just reuse an object you already had there, as you are going to evict it anyway.</p> <p>Instead of:</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Dog</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">dogs</span> <span class="k">=</span> <span class="nv">collection</span><span class="o">.</span><span class="py">mutable</span><span class="o">.</span><span class="py">ArrayBuffer</span><span class="o">(</span><span class="nc">Dog</span><span class="o">(</span><span class="s">"Rex"</span><span class="o">),</span> <span class="nc">Dog</span><span class="o">(</span><span class="s">"Max"</span><span class="o">),</span> <span class="nc">Dog</span><span class="o">(</span><span class="s">"Woof"</span><span class="o">))</span>
<span class="c1">// Replace dog at index 2 with a new one (allocation &amp; deletion)</span>
<span class="nf">dogs</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Dog</span><span class="o">(</span><span class="s">"Cat-Chaser the Dog"</span><span class="o">)</span>
</code></pre></div></div> <p>You could do:</p> <div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">Dog</span><span class="o">(</span><span class="k">var</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">dogs</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">(</span><span class="nc">Dog</span><span class="o">(</span><span class="s">"Rex"</span><span class="o">),</span> <span class="nc">Dog</span><span class="o">(</span><span class="s">"Max"</span><span class="o">),</span> <span class="nc">Dog</span><span class="o">(</span><span class="s">"Woof"</span><span class="o">))</span>
<span class="c1">// Replace dog at index 2 with a new one (no allocation)</span>
<span class="nf">dogs</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="py">name</span> <span class="k">=</span> <span class="s">"Cat-Chaser the Dog"</span>
</code></pre></div></div> <p>Of course, then you have to be 100% sure that you control the lifetime of these instances and that you won‚Äôt, for example, rename someone‚Äôs dog by accident. That would be very unethical.</p> <h2 id="summary">Summary</h2> <p>In short: the less you allocate, the better. I hope these tricks will be useful to someone, but please try to use them responsibly and only if there is a clear performance issue.</p> <p>In future parts of this mini-series I will tackle topics like Scala compiler quirks, polymorphism, and inlining. Stay tuned!</p> <h2 id="footnotes">Footnotes</h2> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1" role="doc-endnote"> <p>I highly recommend the blog of Aleksey Shipil√´v if you want to learn more about how JVM‚Äôs allocation, GC, and other internals work: <a href="https://shipilev.net/jvm/anatomy-quarks/" rel="external nofollow noopener" target="_blank">https://shipilev.net/jvm/anatomy-quarks/</a>¬†<a href="#fnref:1" class="reversefootnote" role="doc-backlink">‚Ü©</a></p> </li> </ol> </div> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Related blog posts</h2> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/pythons-data-science-ecosystem-matures/">Python's data science ecosystem matures ‚Äì the case of Polars</a> </li> <div id="giscus_thread" style="max-width: 930px; margin: 0 auto;"> <script>let giscusTheme=determineComputedTheme(),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"Ostrzyciel/ostrzyciel.github.io","data-repo-id":"R_kgDOMilBnQ","data-category":"ostrzyciel.eu blog comments","data-category-id":"DIC_kwDOMilBnc4ChlmU","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> <div style="padding-bottom: 1.2em; margin-top: 1em;"> <div class="atom-widget"> <a href="/feed.xml" title="RSS/Atom Feed" style="font-size: 1.8rem;"> <i class="fa-solid fa-square-rss"></i> Subscribe (RSS/Atom) </a><br> <i style="color: #222;">RSS/Atom feeds can be read by various applications, like <a href="https://support.mozilla.org/en-US/kb/how-subscribe-news-feeds-and-blogs" rel="external nofollow noopener" target="_blank">Thunderbird</a>, <a href="https://support.microsoft.com/en-us/office/subscribe-to-an-rss-feed-73c6e717-7815-4594-98e5-81fa369e951c" rel="external nofollow noopener" target="_blank">Outlook</a>, some browser extensions, and more. They will show you a notification about new posts on this blog.</i> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> ¬© Copyright 2024 Piotr Sowi≈Ñski. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?601a2d3465e2a52bec38b600518d5f70"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let searchTheme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===searchTheme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"About",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-blog",title:"Blog",description:"",section:"Navigation",handler:()=>{window.location.href="/blog/"}},{id:"nav-publications",title:"Publications",description:"Publications in reverse chronological order.",section:"Navigation",handler:()=>{window.location.href="/publications/"}},{id:"nav-projects-amp-software",title:"Projects &amp; software",description:"Some of the projects and software I have been working on. The list is incomplete, more projects will be added soon.",section:"Navigation",handler:()=>{window.location.href="/projects/"}},{id:"nav-teaching",title:"Teaching",description:"Project and laboratory classes taught by me at Warsaw University of Technology.",section:"Navigation",handler:()=>{window.location.href="/teaching/"}},{id:"post-making-scala-go-fast-avoiding-allocations",title:"Making Scala go fast: avoiding allocations",description:"In this post, we explore the ways in which you can avoid the overhead of allocating things on the heap in Scala 3.",section:"Posts",handler:()=>{window.location.href="/blog/2024/scala-performance-avoiding-allocation/"}},{id:"post-python-39-s-data-science-ecosystem-matures-the-case-of-polars",title:"Python&#39;s data science ecosystem matures \u2013 the case of Polars",description:"It simply feels amazing to finally get something you were waiting for, after many years. This is a story about Python, data science, and software library design. The star: Polars.",section:"Posts",handler:()=>{window.location.href="/blog/2024/pythons-data-science-ecosystem-matures/"}},{id:"projects-jelly",title:"Jelly",description:"Jelly is a high-performance RDF serialization format and streaming protocol",section:"Projects",handler:()=>{window.location.href="/projects/jelly/"}},{id:"projects-jelly-jvm",title:"Jelly-JVM",description:"Jelly-JVM is a blazing-fast implementation of the Jelly streaming protocol for the Java Virtual Machine",section:"Projects",handler:()=>{window.location.href="/projects/jelly_jvm/"}},{id:"projects-rdf-stream-taxonomy",title:"RDF Stream Taxonomy",description:"RDF-STaX organizes RDF stream types and provides a common vocabulary for describing them.",section:"Projects",handler:()=>{window.location.href="/projects/rdf_stax/"}},{id:"projects-riverbench",title:"RiverBench",description:"RiverBench is an open RDF streaming benchmark suite that can be used for a wide range of benchmarking tasks",section:"Projects",handler:()=>{window.location.href="/projects/riverbench/"}},{id:"socials-email",title:"Send email",section:"Socials",handler:()=>{window.open("mailto:%70%69%6F%74%72.%73%6F%77%69%6E%73%6B%69.%64%6F%6B%74@%70%77.%65%64%75.%70%6C","_blank")}},{id:"socials-orcid",title:"ORCID",section:"Socials",handler:()=>{window.open("https://orcid.org/0000-0002-2543-9461","_blank")}},{id:"socials-google-scholar",title:"Google Scholar",section:"Socials",handler:()=>{window.open("https://scholar.google.com/citations?user=MPj9pngAAAAJ","_blank")}},{id:"socials-researchgate",title:"ResearchGate",section:"Socials",handler:()=>{window.open("https://www.researchgate.net/profile/Piotr_Sowinski2/","_blank")}},{id:"socials-github",title:"GitHub",section:"Socials",handler:()=>{window.open("https://github.com/Ostrzyciel","_blank")}},{id:"socials-linkedin",title:"LinkedIn",section:"Socials",handler:()=>{window.open("https://www.linkedin.com/in/piotr-sowinski","_blank")}},{id:"socials-rss",title:"RSS Feed",section:"Socials",handler:()=>{window.open("/feed.xml","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>